{
 "Description": "Database infrastructure for staging environment",
 "Parameters": {
  "SsmParameterValueordernimbusstagingdatabasemasterusernameC96584B6F00A464EAD1953AFF4B05118Parameter": {
   "Type": "AWS::SSM::Parameter::Value<String>",
   "Default": "/ordernimbus/staging/database/master-username"
  },
  "SsmParameterValueordernimbusstagingdatabasenameC96584B6F00A464EAD1953AFF4B05118Parameter": {
   "Type": "AWS::SSM::Parameter::Value<String>",
   "Default": "/ordernimbus/staging/database/name"
  },
  "BootstrapVersion": {
   "Type": "AWS::SSM::Parameter::Value<String>",
   "Default": "/cdk-bootstrap/hnb659fds/version",
   "Description": "Version of the CDK Bootstrap resources in this environment, automatically retrieved from SSM Parameter Store. [cdk:skip]"
  }
 },
 "Resources": {
  "DBSubnetGroup": {
   "Type": "AWS::RDS::DBSubnetGroup",
   "Properties": {
    "DBSubnetGroupDescription": "Database subnet group for staging",
    "SubnetIds": [
     {
      "Fn::ImportValue": "ordernimbus-staging-networking:ExportsOutputRefVPCDatabaseSubnet1Subnet3E790B6FCC2F250A"
     },
     {
      "Fn::ImportValue": "ordernimbus-staging-networking:ExportsOutputRefVPCDatabaseSubnet2Subnet93B13DD5FBB3CDD7"
     }
    ],
    "Tags": [
     {
      "Key": "CostCenter",
      "Value": "Engineering"
     },
     {
      "Key": "Environment",
      "Value": "staging"
     },
     {
      "Key": "Owner",
      "Value": "Platform-Team"
     },
     {
      "Key": "Project",
      "Value": "OrderNimbus-Forecasting"
     }
    ]
   },
   "Metadata": {
    "aws:cdk:path": "ordernimbus-staging-database/DBSubnetGroup/Default"
   }
  },
  "AuroraClusterMonitoringRoleEC6D6395": {
   "Type": "AWS::IAM::Role",
   "Properties": {
    "AssumeRolePolicyDocument": {
     "Statement": [
      {
       "Action": "sts:AssumeRole",
       "Effect": "Allow",
       "Principal": {
        "Service": "monitoring.rds.amazonaws.com"
       }
      }
     ],
     "Version": "2012-10-17"
    },
    "ManagedPolicyArns": [
     {
      "Fn::Join": [
       "",
       [
        "arn:",
        {
         "Ref": "AWS::Partition"
        },
        ":iam::aws:policy/service-role/AmazonRDSEnhancedMonitoringRole"
       ]
      ]
     }
    ],
    "Tags": [
     {
      "Key": "CostCenter",
      "Value": "Engineering"
     },
     {
      "Key": "Environment",
      "Value": "staging"
     },
     {
      "Key": "Owner",
      "Value": "Platform-Team"
     },
     {
      "Key": "Project",
      "Value": "OrderNimbus-Forecasting"
     }
    ]
   },
   "Metadata": {
    "aws:cdk:path": "ordernimbus-staging-database/AuroraCluster/MonitoringRole/Resource"
   }
  },
  "ordernimbusstagingdatabaseAuroraClusterSecretF0EE42063fdaad7efa858a3daf9490cf0a702aeb": {
   "Type": "AWS::SecretsManager::Secret",
   "Properties": {
    "Description": {
     "Fn::Join": [
      "",
      [
       "Generated by the CDK for stack: ",
       {
        "Ref": "AWS::StackName"
       }
      ]
     ]
    },
    "GenerateSecretString": {
     "ExcludeCharacters": " %+~`#$&*()|[]{}:;<>?!'/@\"\\",
     "GenerateStringKey": "password",
     "PasswordLength": 30,
     "SecretStringTemplate": {
      "Fn::Join": [
       "",
       [
        "{\"username\":\"",
        {
         "Ref": "SsmParameterValueordernimbusstagingdatabasemasterusernameC96584B6F00A464EAD1953AFF4B05118Parameter"
        },
        "\"}"
       ]
      ]
     }
    },
    "Name": "ordernimbus-staging-db-credentials",
    "Tags": [
     {
      "Key": "CostCenter",
      "Value": "Engineering"
     },
     {
      "Key": "Environment",
      "Value": "staging"
     },
     {
      "Key": "Owner",
      "Value": "Platform-Team"
     },
     {
      "Key": "Project",
      "Value": "OrderNimbus-Forecasting"
     }
    ]
   },
   "UpdateReplacePolicy": "Delete",
   "DeletionPolicy": "Delete",
   "Metadata": {
    "aws:cdk:path": "ordernimbus-staging-database/AuroraCluster/Secret/Resource"
   }
  },
  "AuroraClusterSecretAttachmentDB8032DA": {
   "Type": "AWS::SecretsManager::SecretTargetAttachment",
   "Properties": {
    "SecretId": {
     "Ref": "ordernimbusstagingdatabaseAuroraClusterSecretF0EE42063fdaad7efa858a3daf9490cf0a702aeb"
    },
    "TargetId": {
     "Ref": "AuroraCluster23D869C0"
    },
    "TargetType": "AWS::RDS::DBCluster"
   },
   "Metadata": {
    "aws:cdk:path": "ordernimbus-staging-database/AuroraCluster/Secret/Attachment/Resource"
   }
  },
  "AuroraCluster23D869C0": {
   "Type": "AWS::RDS::DBCluster",
   "Properties": {
    "BackupRetentionPeriod": 7,
    "CopyTagsToSnapshot": true,
    "DBClusterIdentifier": "ordernimbus-staging-db-cluster",
    "DBClusterParameterGroupName": "default.aurora-postgresql15",
    "DBSubnetGroupName": {
     "Ref": "DBSubnetGroup"
    },
    "DatabaseName": {
     "Ref": "SsmParameterValueordernimbusstagingdatabasenameC96584B6F00A464EAD1953AFF4B05118Parameter"
    },
    "DeletionProtection": false,
    "Engine": "aurora-postgresql",
    "EngineVersion": "15.4",
    "MasterUserPassword": {
     "Fn::Join": [
      "",
      [
       "{{resolve:secretsmanager:",
       {
        "Ref": "ordernimbusstagingdatabaseAuroraClusterSecretF0EE42063fdaad7efa858a3daf9490cf0a702aeb"
       },
       ":SecretString:password::}}"
      ]
     ]
    },
    "MasterUsername": {
     "Ref": "SsmParameterValueordernimbusstagingdatabasemasterusernameC96584B6F00A464EAD1953AFF4B05118Parameter"
    },
    "PerformanceInsightsEnabled": true,
    "PerformanceInsightsRetentionPeriod": 7,
    "Port": 5432,
    "PreferredBackupWindow": "03:00-04:00",
    "ServerlessV2ScalingConfiguration": {
     "MaxCapacity": 16,
     "MinCapacity": 0.5
    },
    "StorageEncrypted": true,
    "Tags": [
     {
      "Key": "CostCenter",
      "Value": "Engineering"
     },
     {
      "Key": "Environment",
      "Value": "staging"
     },
     {
      "Key": "Owner",
      "Value": "Platform-Team"
     },
     {
      "Key": "Project",
      "Value": "OrderNimbus-Forecasting"
     }
    ],
    "VpcSecurityGroupIds": [
     {
      "Fn::ImportValue": "ordernimbus-staging-security:ExportsOutputFnGetAttDatabaseSecurityGroup7319C0F6GroupId72A1B827"
     }
    ]
   },
   "UpdateReplacePolicy": "Delete",
   "DeletionPolicy": "Delete",
   "Metadata": {
    "aws:cdk:path": "ordernimbus-staging-database/AuroraCluster/Resource"
   }
  },
  "AuroraClusterwriter499C523E": {
   "Type": "AWS::RDS::DBInstance",
   "Properties": {
    "DBClusterIdentifier": {
     "Ref": "AuroraCluster23D869C0"
    },
    "DBInstanceClass": "db.serverless",
    "Engine": "aurora-postgresql",
    "MonitoringInterval": 60,
    "MonitoringRoleArn": {
     "Fn::GetAtt": [
      "AuroraClusterMonitoringRoleEC6D6395",
      "Arn"
     ]
    },
    "PromotionTier": 0,
    "PubliclyAccessible": false,
    "Tags": [
     {
      "Key": "CostCenter",
      "Value": "Engineering"
     },
     {
      "Key": "Environment",
      "Value": "staging"
     },
     {
      "Key": "Owner",
      "Value": "Platform-Team"
     },
     {
      "Key": "Project",
      "Value": "OrderNimbus-Forecasting"
     }
    ]
   },
   "UpdateReplacePolicy": "Delete",
   "DeletionPolicy": "Delete",
   "Metadata": {
    "aws:cdk:path": "ordernimbus-staging-database/AuroraCluster/writer/Resource"
   }
  },
  "CDKMetadata": {
   "Type": "AWS::CDK::Metadata",
   "Properties": {
    "Analytics": "v2:deflate64:H4sIAAAAAAAA/22MsW7DMAxEvyW7zNqeurYOUHRqYXcPaJlJlVh0IFLJIOjfC9kN0KHT4e7dXQtt/Qz1Du9S2elSzW6ENCjai+mO/IkBPSkF05MsMVgyeJdDCpNAGuLIpG9hidfS3b/+DfaoOKJQN0cp+4cfyAbSrf9gq3lnUWRL2Tj0kPplpgKKZiPrSjwynihA6o78e7TJF4YT6Ysq2m9PvP7/T3Iu7CPqNWo2vEwEZ3m6tTU0DTS7szhXhcjqPEG/6Q+Pu9Q6IwEAAA=="
   },
   "Metadata": {
    "aws:cdk:path": "ordernimbus-staging-database/CDKMetadata/Default"
   }
  }
 },
 "Outputs": {
  "DatabaseEndpoint": {
   "Description": "Aurora Cluster Endpoint",
   "Value": {
    "Fn::GetAtt": [
     "AuroraCluster23D869C0",
     "Endpoint.Address"
    ]
   },
   "Export": {
    "Name": "staging-db-endpoint"
   }
  },
  "DatabaseName": {
   "Description": "Database Name",
   "Value": {
    "Ref": "SsmParameterValueordernimbusstagingdatabasenameC96584B6F00A464EAD1953AFF4B05118Parameter"
   },
   "Export": {
    "Name": "staging-db-name"
   }
  },
  "ExportsOutputFnGetAttAuroraCluster23D869C0EndpointAddress064B8907": {
   "Value": {
    "Fn::GetAtt": [
     "AuroraCluster23D869C0",
     "Endpoint.Address"
    ]
   },
   "Export": {
    "Name": "ordernimbus-staging-database:ExportsOutputFnGetAttAuroraCluster23D869C0EndpointAddress064B8907"
   }
  },
  "ExportsOutputRefAuroraClusterSecretAttachmentDB8032DAFDEEBE73": {
   "Value": {
    "Ref": "AuroraClusterSecretAttachmentDB8032DA"
   },
   "Export": {
    "Name": "ordernimbus-staging-database:ExportsOutputRefAuroraClusterSecretAttachmentDB8032DAFDEEBE73"
   }
  },
  "ExportsOutputRefAuroraCluster23D869C0CA1C7DB5": {
   "Value": {
    "Ref": "AuroraCluster23D869C0"
   },
   "Export": {
    "Name": "ordernimbus-staging-database:ExportsOutputRefAuroraCluster23D869C0CA1C7DB5"
   }
  }
 },
 "Rules": {
  "CheckBootstrapVersion": {
   "Assertions": [
    {
     "Assert": {
      "Fn::Not": [
       {
        "Fn::Contains": [
         [
          "1",
          "2",
          "3",
          "4",
          "5"
         ],
         {
          "Ref": "BootstrapVersion"
         }
        ]
       }
      ]
     },
     "AssertDescription": "CDK bootstrap stack version 6 required. Please run 'cdk bootstrap' with a recent version of the CDK CLI."
    }
   ]
  }
 }
}